name: 构建并部署 Spring Boot 应用

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, ARM64]

    steps:
      # 1️⃣ 拉取最新代码
      - name: 拉取代码
        uses: actions/checkout@v4

      # 2️⃣ 设置 JDK 17
      - name: 设置 JDK 17 环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3️⃣ 赋予 mvnw 可执行权限
      - name: 赋予 mvnw 可执行权限
        run: chmod +x mvnw

      # 4️⃣ 构建 Spring Boot 项目
      - name: 构建项目
        run: ./mvnw clean package -DskipTests -B -q

      # 5️⃣ 部署应用（通过 systemd）
      - name: 部署应用
        shell: bash
        run: |
          set -euo pipefail

          # 选择最新且非 *.jar.original 的 JAR
          JAR_FILE=$(find target -maxdepth 1 -type f -name "*.jar" ! -name "*.jar.original" -printf "%T@ %p\n" | sort -nr | awk 'NR==1{print $2}')
          if [ -z "${JAR_FILE:-}" ]; then
            echo "未找到可部署的 JAR 文件"
            exit 1
          fi

          APP_DIR="$HOME/hello"
          mkdir -p "$APP_DIR"
          cp "$JAR_FILE" "$APP_DIR/app.jar"

          SERVICE_FILE="/etc/systemd/system/hello.service"
          sudo tee "$SERVICE_FILE" >/dev/null <<EOF
          [Unit]
          Description=Hello Spring Boot App
          After=network-online.target
          Wants=network-online.target

          [Service]
          User=$USER
          WorkingDirectory=$APP_DIR
          ExecStart=/usr/bin/env java -jar $APP_DIR/app.jar
          SuccessExitStatus=143
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
          EOF

          sudo systemctl daemon-reload
          sudo systemctl enable hello.service
          sudo systemctl restart hello.service
          sudo systemctl --no-pager status hello.service
